

# Home Health Outlook — Unified Module Implementation Plan (QC-Approved)

## Summary

This plan consolidates Habitta's fragmented health display (HomeHealthCard + DualPathForecast + CapitalTimeline) into a **single unified truth surface** that establishes inspector-grade credibility through explicit causality.

**Transformation:**
- **Before:** Score card → DualPathForecast bars ("With Habitta / If untracked") → Separate CapitalTimeline
- **After:** Score → Causality ("What's influencing this") → System Trajectories (unified causal chain)

---

## QC Refinements Integrated

| Issue | Resolution |
|-------|------------|
| `trajectorysSectionTitle` typo | Fixed to `trajectoriesSectionTitle` |
| `deriveContributorLevel` underspecified | Added doc comment explaining heuristic nature, override potential |
| `climateContext` semantics undefined | Defined as `ClimateContextType` with explicit values |
| Visual indicator colors too alarming | Desaturated to clay/ochre/sage palette |
| Fallback handling incomplete | Explicit "limited information" copy, no invented causality |
| Cost range location rule undocumented | Added explicit rule: costs only in Trajectories section |

---

## What Gets Eliminated (Ruthlessly)

| Component/Copy | Reason |
|----------------|--------|
| `DualPathForecast.tsx` | "With Habitta / If untracked" implies we change physics |
| `withHabittaCare` branch in HomeForecast | Stewardship doesn't promise score stabilization |
| "24-Month Outlook (Relative Home Health Index)" | Fake precision, churny SaaS language |
| Green/amber bar comparison | Binary framing creates false certainty |
| "-4 points" math attribution | Treats users like children |
| Time horizon in score | Irrelevant unless user explicitly asks |

---

## Files Summary

| File | Action | Scope |
|------|--------|-------|
| `src/lib/homeHealthOutlookCopy.ts` | **Create** | Copy governance module with banned phrases enforcement |
| `src/components/HomeHealthOutlook.tsx` | **Create** | Unified 3-layer component (Score → Causality → Trajectories) |
| `src/components/home-health/DualPathForecast.tsx` | **Delete** | No longer needed |
| `src/components/home-health/index.ts` | **Modify** | Remove DualPathForecast export |
| `src/components/HomeHealthCard.tsx` | **Modify** | Simplify for fallback use only |
| `src/components/CapitalTimeline.tsx` | **Modify** | Rename header, add contributor indicator support |
| `src/components/SystemTimelineLane.tsx` | **Modify** | Add contributor indicator, refine tooltip copy |
| `src/components/dashboard-v3/MiddleColumn.tsx` | **Modify** | Replace HomeHealthCard + CapitalTimeline with unified component |
| `src/types/systemPrediction.ts` | **Modify** | Remove `withHabittaCare`, add `systemInfluences` |
| `src/lib/dashboardCopy.ts` | **Modify** | Remove obsolete bar graph copy |

---

## Part 1: Copy Governance Module

**File:** `src/lib/homeHealthOutlookCopy.ts`

### Purpose

Single source of truth for Home Health Outlook copy. Enforces product doctrine with compile-time banned phrase validation.

### Types

```typescript
// Contributor level (interpretive, not mathematical)
export type ContributorLevel = 'primary' | 'moderate' | 'minor';

// Climate context with explicit semantics (QC refinement)
export type ClimateContextType = 
  | 'south_florida'    // High heat, humidity, UV exposure
  | 'coastal'          // Salt air, corrosion risk
  | 'freeze_thaw'      // Ice, foundation stress
  | 'temperate';       // Standard wear patterns

// Install source for causality descriptions
export type InstallSourceType = 'permit' | 'inferred' | 'unknown';

// Lifecycle position
export type LifecyclePosition = 'early' | 'mid' | 'late' | 'end';

// System influence for causality section
export interface SystemInfluence {
  systemKey: 'hvac' | 'roof' | 'water_heater';
  displayName: string;
  contributorLevel: ContributorLevel;
  description: string; // Plain English causality (generated by deriveInfluenceDescription)
}

// Full copy contract
export interface HomeHealthOutlookCopy {
  header: string;
  scoreSubtext: string;
  causalitySectionTitle: string;
  trajectoriesSectionTitle: string;  // Fixed typo
  trajectoriesSectionSubhead: string;
  legendLabels: Record<ContributorLevel, string>;
  interactionCopy: {
    whyThisMatters: string;
    stabilizeHint: string;
  };
  tooltipRefinements: {
    estimatedSource: string;
    observedWindow: string;
  };
  fallbackCopy: {
    limitedInfoNote: string;  // QC refinement
  };
}
```

### Key Functions

```typescript
/**
 * Determines contributor level using heuristic judgment,
 * not strict point math. May be overridden by climate stress
 * or lifecycle signals.
 * 
 * Thresholds are NOT absolute:
 * - Primary: remainingYears <= 5 AND confidence > 0.5
 * - Moderate: remainingYears <= 10 OR (remainingYears <= 7 AND confidence < 0.5)
 * - Minor: remainingYears > 10
 * 
 * Climate stress can elevate a system by one level.
 * Lifecycle position can also override (end-of-life → at least moderate).
 */
export function deriveContributorLevel(
  remainingYears: number,
  confidence: number,
  lifecyclePosition?: LifecyclePosition,
  climateContext?: ClimateContextType
): ContributorLevel;

/**
 * Generate plain English causality description for a system.
 * No timelines, no costs, no urgent verbs.
 */
export function deriveInfluenceDescription(
  systemKey: SystemKey,
  installSource: InstallSourceType,
  lifecyclePosition: LifecyclePosition,
  hasRecentService: boolean,
  climateContext?: ClimateContextType
): string;

/**
 * Get static copy for the outlook module.
 */
export function getHomeHealthOutlookCopy(): HomeHealthOutlookCopy;
```

### Banned Phrases (Enforced)

The module will include a validation function and constant list:

```typescript
// These phrases are explicitly prohibited in any outlook copy
export const BANNED_PHRASES = [
  'If left untracked',
  'Without Habitta',
  'With Habitta',
  'Prevent failure',
  'Avoid disaster',
  'Your home will',
  'points',
  '24-Month Outlook',
  'failing',
  'urgent',
  'critical',
  'immediately',
] as const;
```

### Static Copy

```typescript
export function getHomeHealthOutlookCopy(): HomeHealthOutlookCopy {
  return {
    header: 'Home Health',
    scoreSubtext: 'This outlook reflects system age, climate exposure, and current maintenance visibility.',
    causalitySectionTitle: "What's influencing this outlook",
    trajectoriesSectionTitle: 'System Trajectories',
    trajectoriesSectionSubhead: 'These systems shape how your home\'s health evolves over time.',
    legendLabels: {
      primary: 'Meaningfully affects overall home health trajectory',
      moderate: 'Gradual influence',
      minor: 'Limited near-term impact',
    },
    interactionCopy: {
      whyThisMatters: 'This system is currently influencing your home\'s projected health trend due to its age and verification status.',
      stabilizeHint: 'Updating maintenance history or install details can stabilize this outlook.',
    },
    tooltipRefinements: {
      estimatedSource: 'Based on permits, records, and regional averages',
      observedWindow: 'Observed replacement window',
    },
    fallbackCopy: {
      limitedInfoNote: 'Limited information available. Estimates will improve as details are added.',
    },
  };
}
```

---

## Part 2: Unified Component

**File:** `src/components/HomeHealthOutlook.tsx`

### Props

```typescript
interface HomeHealthOutlookProps {
  forecast: HomeForecast;
  capitalTimeline: HomeCapitalTimeline | null;
  onSystemClick: (systemKey: string) => void;
  isLoading?: boolean;
}
```

### Component Structure

**Layer 1: Score (Outcome)**
- Header: "Home Health" (not "Forecast")
- Score trajectory: `{currentScore} → {projectedScore}` (arrow indicates direction)
- Subtext: Reflects system age, climate, maintenance visibility
- **No time horizon shown** (unless explicitly requested)
- **No "With Habitta" comparison**

**Layer 2: Causality (What's Influencing This)**
- Section title: "What's influencing this outlook"
- Max 3 systems listed, ordered by contributor level (primary first)
- Each system: Name + plain English description
- **No timelines, no costs, no urgent verbs**

**Layer 3: Evidence (System Trajectories)**
- Renamed from "Home Systems Timeline"
- Each row has contributor indicator (thin left edge):
  - Clay/rust = Primary contributor (desaturated red)
  - Ochre = Moderate contributor (desaturated amber)
  - Sage = Minor contributor (desaturated green)
- **Cost ranges appear ONLY here** (not in causality, not in score)
- Clicking system shows interaction copy

### Visual Color Palette (QC Refinement)

Desaturated to reduce alarm while maintaining semantics:

```typescript
const CONTRIBUTOR_COLORS = {
  primary: 'bg-red-300/70',    // Clay/rust - desaturated
  moderate: 'bg-amber-300/70', // Ochre - desaturated
  minor: 'bg-emerald-300/70',  // Sage - desaturated
} as const;
```

### Rendering Structure

```tsx
<Card className="rounded-2xl border-t-2 border-t-primary/20">
  <CardContent className="p-5 space-y-4">
    {/* Layer 1: Score */}
    <div className="space-y-1">
      <span className="heading-h3 text-foreground">{copy.header}</span>
      <div className="flex items-baseline gap-2">
        <span className="text-5xl font-semibold tabular-nums">{currentScore}</span>
        <span className="text-xl text-muted-foreground">→</span>
        <span className="text-3xl text-muted-foreground tabular-nums">{projectedScore}</span>
      </div>
      <p className="text-sm text-muted-foreground">{copy.scoreSubtext}</p>
    </div>

    {/* Layer 2: Causality */}
    <div className="space-y-3 pt-4 border-t">
      <h4 className="text-sm font-medium text-muted-foreground">
        {copy.causalitySectionTitle}
      </h4>
      {systemInfluences.slice(0, 3).map(influence => (
        <div key={influence.systemKey} className="space-y-0.5">
          <span className="font-medium">{influence.displayName}</span>
          <p className="text-sm text-muted-foreground">{influence.description}</p>
        </div>
      ))}
    </div>

    {/* Layer 3: System Trajectories */}
    <div className="space-y-3 pt-4 border-t">
      <div>
        <h4 className="text-sm font-medium">{copy.trajectoriesSectionTitle}</h4>
        <p className="text-xs text-muted-foreground">{copy.trajectoriesSectionSubhead}</p>
      </div>
      {/* Timeline lanes with contributor indicators */}
      {capitalTimeline?.systems.map(system => (
        <SystemTimelineLane
          key={system.systemId}
          system={system}
          startYear={currentYear}
          endYear={endYear}
          contributorLevel={getContributorLevel(system.systemId)}
          showContributorIndicator={true}
          onClick={() => handleSystemClick(system.systemId)}
        />
      ))}
      {/* Legend */}
      <div className="flex items-center gap-4 text-xs text-muted-foreground pt-2">
        <div className="flex items-center gap-1.5">
          <div className="w-1.5 h-3 bg-red-300/70 rounded-full" />
          <span>Primary</span>
        </div>
        <div className="flex items-center gap-1.5">
          <div className="w-1.5 h-3 bg-amber-300/70 rounded-full" />
          <span>Moderate</span>
        </div>
        <div className="flex items-center gap-1.5">
          <div className="w-1.5 h-3 bg-emerald-300/70 rounded-full" />
          <span>Minor</span>
        </div>
      </div>
    </div>

    {/* Interaction: Selected system explanation */}
    {selectedSystem && (
      <div className="bg-muted/50 rounded-lg p-3 space-y-1 animate-in fade-in">
        <p className="text-sm font-medium">Why this matters</p>
        <p className="text-sm text-muted-foreground">{copy.interactionCopy.whyThisMatters}</p>
        <p className="text-xs text-muted-foreground italic">{copy.interactionCopy.stabilizeHint}</p>
      </div>
    )}
  </CardContent>
</Card>
```

---

## Part 3: Fallback Component

**File:** `src/components/HomeHealthOutlook.tsx` (same file, separate component)

```typescript
interface HomeHealthOutlookFallbackProps {
  score: number;
  isHealthyState?: boolean;
}

/**
 * HomeHealthOutlookFallback - Renders when full forecast unavailable
 * 
 * CRITICAL (QC refinement):
 * - Explicitly states "limited information"
 * - Does NOT invent causality
 * - Does NOT show trajectories (no data to support them)
 */
export function HomeHealthOutlookFallback({ score, isHealthyState }: HomeHealthOutlookFallbackProps) {
  const copy = getHomeHealthOutlookCopy();
  
  return (
    <Card className="rounded-2xl border-t-2 border-t-muted/40">
      <CardContent className="p-5 space-y-3">
        <div className="space-y-1">
          <span className="heading-h3 text-foreground">{copy.header}</span>
          <div className="text-4xl font-semibold tabular-nums text-muted-foreground">
            {score}
          </div>
        </div>
        <p className="text-sm text-muted-foreground italic">
          {copy.fallbackCopy.limitedInfoNote}
        </p>
      </CardContent>
    </Card>
  );
}
```

---

## Part 4: SystemTimelineLane Modifications

**File:** `src/components/SystemTimelineLane.tsx`

### New Props

```typescript
interface SystemTimelineLaneProps {
  system: ExtendedSystemTimelineEntry;
  startYear: number;
  endYear: number;
  onClick?: () => void;
  // NEW: Contributor level for score connection
  contributorLevel?: ContributorLevel;
  // NEW: Whether to show the contributor indicator
  showContributorIndicator?: boolean;
}
```

### Changes

1. **Add contributor indicator** (thin left edge, desaturated colors):
```tsx
{showContributorIndicator && contributorLevel && (
  <div className={cn(
    "w-1.5 h-full rounded-full mr-2 shrink-0",
    contributorLevel === 'primary' && "bg-red-300/70",
    contributorLevel === 'moderate' && "bg-amber-300/70",
    contributorLevel === 'minor' && "bg-emerald-300/70"
  )} />
)}
```

2. **Rename tooltip labels** (lines 99-101):
   - "Estimated" → "Based on permits, records, and regional averages"

3. **Rename legend labels** (currently in CapitalTimeline):
   - "Most likely" → "Observed replacement window"

---

## Part 5: CapitalTimeline Modifications

**File:** `src/components/CapitalTimeline.tsx`

### Changes

1. **Rename header** (line 39):
   - From: `Home Systems Timeline`
   - To: `System Trajectories`

2. **Update subhead** (if present):
   - Add: "These systems shape how your home's health evolves over time."

3. **Update legend** (lines 96-98):
   - From: "Most likely"
   - To: "Observed replacement window"

---

## Part 6: Type System Updates

**File:** `src/types/systemPrediction.ts`

### HomeForecast Changes

**Remove:**
```typescript
// DELETE - Stewardship doesn't promise score stabilization
withHabittaCare: {
  score12mo: number;
  score24mo: number;
  stabilizers: string[];
};
```

**Add:**
```typescript
// ADD - Explicit causality for unified module
systemInfluences?: Array<{
  systemKey: 'hvac' | 'roof' | 'water_heater';
  contributorLevel: 'primary' | 'moderate' | 'minor';
  lifecyclePosition: 'early' | 'mid' | 'late' | 'end';
  installSource: 'permit' | 'inferred' | 'unknown';
  hasRecentService: boolean;
  climateContext?: 'south_florida' | 'coastal' | 'freeze_thaw' | 'temperate';
}>;
```

---

## Part 7: MiddleColumn Integration

**File:** `src/components/dashboard-v3/MiddleColumn.tsx`

### Layout Change

**Current (lines 346-395):**
```
3. HomeHealthCard
4. HabittaThinking
5. CapitalTimeline
```

**New:**
```
3. HomeHealthOutlook (unified - replaces both HomeHealthCard and CapitalTimeline)
4. HabittaThinking
```

### Integration Code

```tsx
import { HomeHealthOutlook, HomeHealthOutlookFallback } from "@/components/HomeHealthOutlook";

// In render:
{/* 3. Home Health Outlook - Unified truth surface */}
<section ref={healthCardRef}>
  {forecastLoading || timelineLoading ? (
    <Skeleton className="h-96 rounded-2xl" />
  ) : homeForecast && capitalTimeline ? (
    <HomeHealthOutlook
      forecast={homeForecast}
      capitalTimeline={capitalTimeline}
      onSystemClick={handleSystemClick}
    />
  ) : (
    <HomeHealthOutlookFallback 
      score={getOverallScore()}
      isHealthyState={isHealthyState}
    />
  )}
</section>
```

---

## Part 8: DualPathForecast Removal

**File:** `src/components/home-health/DualPathForecast.tsx` — **DELETE**

**File:** `src/components/home-health/index.ts` — Remove export:
```typescript
// DELETE this line:
export { DualPathForecast } from './DualPathForecast';
```

---

## Part 9: HomeHealthCard Simplification

**File:** `src/components/HomeHealthCard.tsx`

### Changes

1. **Remove DualPathForecast import** (line 9)
2. **Remove DualPathForecast rendering** (lines 166-170)
3. **Remove withHabittaCare references** (lines 75, 155-163)
4. **Keep LegacyHomeHealthCard** for backward compatibility only
5. **Add deprecation notice** in component docstring

The component becomes a legacy fallback only, eventually to be removed.

---

## Product Doctrine (Immutable — Enforced by Code)

### Cost Range Location Rule (QC Addition)

> **System Trajectories is the ONLY place cost ranges appear.**
> 
> Never in:
> - Score section
> - Causality section
> - System Watch
> - Alerts
> 
> Costs belong after understanding, not before.
> This keeps Habitta from drifting into "financial anxiety dashboard."

### Score Semantics

> **X → Y means:** "If current assumptions remain unchanged, this is the expected directional shift."
> 
> It does NOT mean: Failure, Neglect, Urgency, or Loss caused by cancellation.

### Contributor Levels

> **Contributor levels are interpretive, not mathematical.**
> 
> Never show point deltas to users.
> Internally, calculate them. Externally, don't.

### The Screenshot Test

> A user should be able to screenshot this module and send it to their spouse, contractor, realtor, or inspector — and no one rolls their eyes.

---

## Acceptance Tests

### Score Layer
- [ ] Shows score trajectory without time horizon (X → Y)
- [ ] Arrow indicates direction without blame
- [ ] Subtext mentions "system age, climate exposure, and maintenance visibility"
- [ ] No "With Habitta" / "If untracked" comparison visible
- [ ] No costs shown in score section

### Causality Layer
- [ ] Title is "What's influencing this outlook"
- [ ] Max 3 systems shown, ordered by contributor level
- [ ] Each system has plain English description
- [ ] No timelines in causality section
- [ ] No costs in causality section
- [ ] No alarmist verbs ("failing", "urgent", "critical")

### Trajectories Layer
- [ ] Section titled "System Trajectories" (not "Timeline")
- [ ] Subhead: "These systems shape how your home's health evolves over time"
- [ ] Each row has contributor indicator (desaturated dot on left)
- [ ] Indicator colors: clay = primary, ochre = moderate, sage = minor
- [ ] Cost ranges appear ONLY here
- [ ] No point math shown ("-4 points")
- [ ] "Estimated" → "Based on permits, records, and regional averages"
- [ ] "Most likely" → "Observed replacement window"

### Fallback
- [ ] Shows score without trajectory
- [ ] Explicitly states "Limited information available"
- [ ] Does NOT invent causality
- [ ] Does NOT show system trajectories

### Interaction
- [ ] Clicking system shows "Why this matters" explanation
- [ ] Explanation mentions age and verification status
- [ ] Optional "stabilize" hint appears when relevant

### Banned Phrases
- [ ] "If left untracked" — NOWHERE
- [ ] "Without Habitta" — NOWHERE
- [ ] "With Habitta" — NOWHERE
- [ ] "24-Month Outlook" — NOWHERE
- [ ] "-X points" — NOWHERE

